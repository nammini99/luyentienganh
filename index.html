<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Học tập: TEST---11</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4f46e5; 
            --primary-light: #eef2ff;
            --bg: #f8fafc; 
            --text: #1e293b; 
            --correct: #10b981; 
            --correct-bg: #f0fdf4;
            --wrong: #ef4444; 
            --wrong-bg: #fef2f2;
            --border: #e2e8f0;
            --solution-bg: #f5f3ff;
            --solution-text: #4338ca;
        }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: var(--text); line-height: 1.6; margin: 0; padding: 0; transition: background-color 0.3s; }
        
        .branding-header { background: #000; color: #fbbf24; padding: 12px 20px; text-align: center; font-weight: 800; font-size: 0.95rem; letter-spacing: 0.05em; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .app-sub-header { background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); padding: 10px 20px; display: flex; justify-content: flex-end; position: sticky; top: 45px; z-index: 900; }
        
        .container { max-width: 900px; margin: 40px auto; padding: 0 20px; }
        .card { background: white; border-radius: 32px; padding: 40px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05); margin-bottom: 24px; border: 1px solid var(--border); }
        
        .setup-header { text-align: center; margin-bottom: 40px; }
        .setup-header h1 { font-weight: 800; color: #0f172a; font-size: 2rem; margin-bottom: 8px; }
        
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; font-weight: 800; font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px; }
        .input-control { width: 100%; padding: 14px 20px; border-radius: 16px; border: 2px solid var(--border); font-family: inherit; font-size: 1rem; font-weight: 600; box-sizing: border-box; }
        
        .theme-picker { display: flex; gap: 10px; align-items: center; margin-top: 5px; }
        .color-dot { width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; cursor: pointer; box-shadow: 0 0 0 2px var(--border); transition: transform 0.2s; }
        .color-dot.active { box-shadow: 0 0 0 2px var(--primary); }
        
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px; background: #f1f5f9; padding: 25px; border-radius: 24px; }
        
        .btn { padding: 16px 32px; border-radius: 18px; font-weight: 800; border: none; cursor: pointer; transition: all 0.2s; font-family: inherit; font-size: 1rem; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-ghost { background: #e2e8f0; color: #475569; }
        
        .progress-bar-wrap { width: 100%; height: 12px; background: #e2e8f0; border-radius: 100px; overflow: hidden; margin: 20px 0; }
        .progress-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .question-text { font-size: 1.5rem; font-weight: 700; margin: 30px 0; color: #0f172a; }
        .question-text strong { color: var(--primary); border-bottom: 3px solid var(--primary-light); }
        
        .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 16px; }
        .option { padding: 20px 24px; border: 2px solid var(--border); border-radius: 20px; display: flex; align-items: center; gap: 18px; cursor: pointer; transition: all 0.2s; background: white; text-align: left; width: 100%; box-sizing: border-box; }
        .option.correct { border-color: var(--correct); background: var(--correct-bg); }
        .option.wrong { border-color: var(--wrong); background: var(--wrong-bg); }
        .option-label-circle { width:36px; height:36px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:800; color: #64748b; background: #f1f5f9; flex-shrink:0; }
        .option.correct .option-label-circle { background: var(--correct); color: white; }
        .option.wrong .option-label-circle { background: var(--wrong); color: white; }

        /* Hướng dẫn giải (Collapse) */
        .solution-wrapper { margin-top: 24px; border-radius: 20px; overflow: hidden; border: 1px solid var(--border); background: white; }
        .solution-header { padding: 16px 24px; background: var(--solution-bg); color: var(--solution-text); font-weight: 800; font-size: 0.9rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; transition: background 0.2s; }
        .solution-header:hover { background: #ede9fe; }
        .solution-content { padding: 0; max-height: 0; overflow: hidden; transition: all 0.3s ease-out; opacity: 0; }
        .solution-content.expanded { padding: 24px; max-height: 1000px; opacity: 1; border-top: 1px solid var(--border); }
        .chevron { transition: transform 0.3s; }
        .chevron.rotated { transform: rotate(180deg); }

        .hidden { display: none; }
        .result-score { font-size: 6rem; font-weight: 900; color: var(--primary); line-height: 1; margin: 20px 0; }
        
        /* Review Styles */
        .review-item { background: white; border: 1px solid var(--border); border-radius: 24px; padding: 30px; margin-bottom: 24px; }
        .review-status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 12px; font-size: 0.8rem; font-weight: 800; text-transform: uppercase; margin-bottom: 20px; }
        .badge-pass { background: var(--correct-bg); color: var(--correct); }
        .badge-fail { background: var(--wrong-bg); color: var(--wrong); }
    </style>
</head>
<body>
    <div class="branding-header">Trợ Lý Nam Mini (0968584585 --- Fb: Nam Mini)</div>
    
    <div id="sub-nav" class="app-sub-header hidden">
        <button class="btn btn-ghost" style="padding: 8px 16px; font-size: 0.8rem; border-radius: 10px;" onclick="goHome()">QUAY LẠI CỬA SỔ CHÍNH</button>
    </div>

    <div class="container">
        <!-- SETUP VIEW -->
        <div id="setup-view" class="card">
            <div class="setup-header">
                <h1>Hệ thống Trắc nghiệm</h1>
                <p style="color: #64748b;">Nhập liệu một lần - Học tập mãi mãi</p>
            </div>

            <div class="input-group">
                <label>Tên bài học</label>
                <input type="text" id="lessonName" class="input-control" placeholder="Ví dụ: Unit 1: Vocabulary" oninput="saveConfig()">
            </div>

            <div class="input-group">
                <label>Dạng bài tập</label>
                <input type="text" id="exerciseType" class="input-control" placeholder="Ví dụ: Multiple Choice" oninput="saveConfig()">
            </div>

            <div class="input-group">
                <label>Màu nền (Theme Solid)</label>
                <div class="theme-picker">
                    <div class="color-dot active" style="background: #f8fafc;" onclick="setTheme('#f8fafc', this)"></div>
                    <div class="color-dot" style="background: #f0fdf4;" onclick="setTheme('#f0fdf4', this)"></div>
                    <div class="color-dot" style="background: #fdf2f8;" onclick="setTheme('#fdf2f8', this)"></div>
                    <div class="color-dot" style="background: #eef2ff;" onclick="setTheme('#eef2ff', this)"></div>
                    <div class="color-dot" style="background: #fffbeb;" onclick="setTheme('#fffbeb', this)"></div>
                    <input type="color" id="customColor" style="width: 32px; height: 32px; padding: 0; border: none; cursor: pointer; border-radius: 50%;" oninput="setTheme(this.value, null)">
                </div>
            </div>

            <div class="settings-grid">
                <div class="input-group" style="margin-bottom: 0;">
                    <label>Số câu hỏi</label>
                    <input type="number" id="limit" class="input-control" value="50" min="1" max="50" style="width: 100px;">
                </div>
                <div style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center;">
                    <label style="font-weight: 800; font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px;">Tùy chọn</label>
                    <div style="display: flex; gap: 20px; font-weight: 700; font-size: 0.9rem;">
                        <label style="cursor: pointer;"><input type="checkbox" id="shuffleQ" checked> Đảo câu</label>
                        <label style="cursor: pointer;"><input type="checkbox" id="shuffleO" checked> Đảo đáp án</label>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" style="margin-top: 40px;" onclick="startQuiz()">BẮT ĐẦU LUYỆN TẬP</button>
        </div>

        <!-- QUIZ VIEW -->
        <div id="quiz-view" class="hidden">
            <div style="margin-bottom: 30px;">
                <h2 id="display-lesson" style="font-size: 1.5rem; font-weight: 800; color: #0f172a; margin: 0;"></h2>
                <p id="display-type" style="font-size: 1rem; font-weight: 700; color: #64748b; margin: 4px 0 20px;"></p>
                <div class="progress-bar-wrap">
                    <div id="progress-bar" class="progress-bar-fill"></div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 800; color: #94a3b8;">
                    <span>TIẾN ĐỘ HOÀN THÀNH</span>
                    <span id="progress-text">0%</span>
                </div>
            </div>

            <div class="card" id="quiz-card-container">
                <div id="question-container"></div>
                <div style="margin-top: 40px; display: flex; gap: 15px;">
                    <button class="btn btn-ghost" style="flex: 1;" onclick="prev()">QUAY LẠI</button>
                    <button id="next-btn" class="btn btn-primary" style="flex: 2;" onclick="next()">TIẾP THEO</button>
                </div>
            </div>
        </div>

        <!-- RESULT VIEW -->
        <div id="result-view" class="card hidden" style="text-align: center;">
            <div class="result-score" id="score-val">0</div>
            <p id="score-total" style="font-size: 1.5rem; color: #94a3b8; font-weight: 800; margin-bottom: 30px;"></p>
            <h2 style="font-weight: 800; font-size: 2rem; margin-bottom: 12px;">Bài thi hoàn tất!</h2>
            <div style="display: flex; flex-direction: column; gap: 15px; align-items: center; margin-top: 40px;">
                <button class="btn btn-primary" style="width: 320px;" onclick="showReview()">XEM LẠI ĐÁP ÁN CHI TIẾT</button>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-ghost" onclick="location.reload()">LÀM LẠI</button>
                    <button class="btn btn-ghost" onclick="goHome()">TRANG CHỦ</button>
                </div>
            </div>
        </div>

        <!-- REVIEW VIEW -->
        <div id="review-view" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="font-weight: 800; font-size: 1.8rem; margin: 0; color: #0f172a;">Báo cáo chi tiết</h2>
                <button class="btn btn-ghost" style="padding: 10px 24px; border-radius: 14px;" onclick="hideReview()">ĐÓNG</button>
            </div>
            <div id="review-container"></div>
        </div>
    </div>

    <script>
        const originalPool = [{"id":1,"content":"Despite his advanced age, the grandfather is still full of ______ and vigour, often outpacing his grandchildren during morning walks.","options":[{"label":"A","isCorrect":true,"text":"vim"},{"label":"B","isCorrect":false,"text":"coin"},{"label":"C","isCorrect":false,"text":"salt"},{"label":"D","isCorrect":false,"text":"brass"}],"hint":""},{"id":2,"content":"After a week of intensive care, the doctor finally announced that the patient had ______ the corner and was expected to recover fully.","options":[{"label":"A","isCorrect":false,"text":"rounded"},{"label":"B","isCorrect":false,"text":"passed"},{"label":"C","isCorrect":true,"text":"turned"},{"label":"D","isCorrect":false,"text":"skipped"}],"hint":""},{"id":3,"content":"Following a strict regimen of diet and exercise, she is now as fit as a ______ .","options":[{"label":"A","isCorrect":false,"text":"violin"},{"label":"B","isCorrect":true,"text":"fiddle"},{"label":"C","isCorrect":false,"text":"whistle"},{"label":"D","isCorrect":false,"text":"flute"}],"hint":""},{"id":4,"content":"I don’t think he can run the marathon this year; to be honest, he is getting a bit long in the ______ .","options":[{"label":"A","isCorrect":false,"text":"leg"},{"label":"B","isCorrect":false,"text":"face"},{"label":"C","isCorrect":false,"text":"nail"},{"label":"D","isCorrect":true,"text":"tooth"}],"hint":""},{"id":5,"content":"The successful heart transplant gave the patient a new ______ of life.","options":[{"label":"A","isCorrect":true,"text":"lease"},{"label":"B","isCorrect":false,"text":"rent"},{"label":"C","isCorrect":false,"text":"loan"},{"label":"D","isCorrect":false,"text":"charter"}],"hint":""},{"id":6,"content":"I won’t be able to come to work today; I’m feeling a bit under the ______ .","options":[{"label":"A","isCorrect":false,"text":"climate"},{"label":"B","isCorrect":false,"text":"rain"},{"label":"C","isCorrect":true,"text":"weather"},{"label":"D","isCorrect":false,"text":"storm"}],"hint":""},{"id":7,"content":"After a thorough medical examination, the executive was given a clean ______ of health.","options":[{"label":"A","isCorrect":false,"text":"sheet"},{"label":"B","isCorrect":true,"text":"bill"},{"label":"C","isCorrect":false,"text":"note"},{"label":"D","isCorrect":false,"text":"receipt"}],"hint":""},{"id":8,"content":"The horse has been off his ______ lately, refusing even the finest hay, which concerns the stable master.","options":[{"label":"A","isCorrect":false,"text":"wheat"},{"label":"B","isCorrect":false,"text":"barley"},{"label":"C","isCorrect":false,"text":"corn"},{"label":"D","isCorrect":true,"text":"oats"}],"hint":""},{"id":9,"content":"After weeks of fasting and illness, the poor man was reduced to nothing but a ______ of bones.","options":[{"label":"A","isCorrect":true,"text":"bag"},{"label":"B","isCorrect":false,"text":"sack"},{"label":"C","isCorrect":false,"text":"box"},{"label":"D","isCorrect":false,"text":"pile"}],"hint":""},{"id":10,"content":"You look like death ______ up! You really should go home and get some rest.","options":[{"label":"A","isCorrect":false,"text":"heated"},{"label":"B","isCorrect":true,"text":"warmed"},{"label":"C","isCorrect":false,"text":"fried"},{"label":"D","isCorrect":false,"text":"boiled"}],"hint":""},{"id":11,"content":"I took the medicine last night, and this morning I feel as right as ______ .","options":[{"label":"A","isCorrect":false,"text":"sun"},{"label":"B","isCorrect":false,"text":"wind"},{"label":"C","isCorrect":true,"text":"rain"},{"label":"D","isCorrect":false,"text":"snow"}],"hint":""},{"id":12,"content":"With his reckless lifestyle and refusal to see a doctor, he practically has one foot in the ______ .","options":[{"label":"A","isCorrect":false,"text":"door"},{"label":"B","isCorrect":false,"text":"coffin"},{"label":"C","isCorrect":false,"text":"pit"},{"label":"D","isCorrect":true,"text":"grave"}],"hint":""},{"id":13,"content":"Despite the rumors of his demise, the legendary actor is still very much alive and ______ .","options":[{"label":"A","isCorrect":true,"text":"kicking"},{"label":"B","isCorrect":false,"text":"punching"},{"label":"C","isCorrect":false,"text":"breathing"},{"label":"D","isCorrect":false,"text":"moving"}],"hint":""},{"id":14,"content":"Realizing that his sedentary lifestyle had caused his health issues was a bitter ______ to swallow.","options":[{"label":"A","isCorrect":false,"text":"tablet"},{"label":"B","isCorrect":true,"text":"pill"},{"label":"C","isCorrect":false,"text":"capsule"},{"label":"D","isCorrect":false,"text":"drop"}],"hint":""},{"id":15,"content":"The surgery was successful, but the patient is not out of the ______ yet; the next 24 hours are critical.","options":[{"label":"A","isCorrect":false,"text":"trees"},{"label":"B","isCorrect":false,"text":"forest"},{"label":"C","isCorrect":true,"text":"woods"},{"label":"D","isCorrect":false,"text":"jungle"}],"hint":""},{"id":16,"content":"The children were full of ______ after eating all that sugary cake at the birthday party.","options":[{"label":"A","isCorrect":false,"text":"peas"},{"label":"B","isCorrect":false,"text":"nuts"},{"label":"C","isCorrect":false,"text":"grapes"},{"label":"D","isCorrect":true,"text":"beans"}],"hint":""},{"id":17,"content":"I was exhausted at the 10-mile mark, but suddenly I got my second ______ and finished the race strong.","options":[{"label":"A","isCorrect":true,"text":"wind"},{"label":"B","isCorrect":false,"text":"breath"},{"label":"C","isCorrect":false,"text":"air"},{"label":"D","isCorrect":false,"text":"breeze"}],"hint":""},{"id":18,"content":"After a stressful year at work, she took a sabbatical to ______ her batteries at a wellness retreat.","options":[{"label":"A","isCorrect":false,"text":"refill"},{"label":"B","isCorrect":true,"text":"recharge"},{"label":"C","isCorrect":false,"text":"replace"},{"label":"D","isCorrect":false,"text":"restore"}],"hint":""},{"id":19,"content":"A week of relaxation by the seaside was just what the ______ ordered.","options":[{"label":"A","isCorrect":false,"text":"nurse"},{"label":"B","isCorrect":false,"text":"surgeon"},{"label":"C","isCorrect":true,"text":"doctor"},{"label":"D","isCorrect":false,"text":"specialist"}],"hint":""},{"id":20,"content":"Thanks to her organic diet and daily yoga, she is in the ______ of health.","options":[{"label":"A","isCorrect":false,"text":"red"},{"label":"B","isCorrect":false,"text":"blue"},{"label":"C","isCorrect":false,"text":"white"},{"label":"D","isCorrect":true,"text":"pink"}],"hint":""},{"id":21,"content":"Look at that baby! Rosy cheeks and bright eyes — she is the very ______ of health.","options":[{"label":"A","isCorrect":true,"text":"picture"},{"label":"B","isCorrect":false,"text":"photo"},{"label":"C","isCorrect":false,"text":"image"},{"label":"D","isCorrect":false,"text":"painting"}],"hint":""},{"id":22,"content":"It’s a relief to hear that your grandmother is ______ the mend after her fall.","options":[{"label":"A","isCorrect":false,"text":"in"},{"label":"B","isCorrect":true,"text":"on"},{"label":"C","isCorrect":false,"text":"at"},{"label":"D","isCorrect":false,"text":"over"}],"hint":""},{"id":23,"content":"During the influenza epidemic of 1918, people were dropping like ______ .","options":[{"label":"A","isCorrect":false,"text":"birds"},{"label":"B","isCorrect":false,"text":"ants"},{"label":"C","isCorrect":true,"text":"flies"},{"label":"D","isCorrect":false,"text":"bees"}],"hint":""},{"id":24,"content":"The hikers were found ______ and sound after being lost in the mountains for three days.","options":[{"label":"A","isCorrect":false,"text":"whole"},{"label":"B","isCorrect":false,"text":"clear"},{"label":"C","isCorrect":false,"text":"secure"},{"label":"D","isCorrect":true,"text":"safe"}],"hint":""},{"id":25,"content":"Put on your coat! It’s freezing outside and you’ll catch your ______ of cold.","options":[{"label":"A","isCorrect":true,"text":"death"},{"label":"B","isCorrect":false,"text":"end"},{"label":"C","isCorrect":false,"text":"life"},{"label":"D","isCorrect":false,"text":"breath"}],"hint":""},{"id":26,"content":"He can eat spicy street food without any issues; he must have a ______ iron stomach.","options":[{"label":"A","isCorrect":false,"text":"wrought"},{"label":"B","isCorrect":true,"text":"cast"},{"label":"C","isCorrect":false,"text":"forged"},{"label":"D","isCorrect":false,"text":"steel"}],"hint":""},{"id":27,"content":"I have a ______ headache, so could you please turn down the music?","options":[{"label":"A","isCorrect":false,"text":"cracking"},{"label":"B","isCorrect":false,"text":"breaking"},{"label":"C","isCorrect":true,"text":"splitting"},{"label":"D","isCorrect":false,"text":"tearing"}],"hint":""},{"id":28,"content":"Longevity seems to ______ in his family; both his parents lived to be over a hundred.","options":[{"label":"A","isCorrect":false,"text":"walk"},{"label":"B","isCorrect":false,"text":"flow"},{"label":"C","isCorrect":false,"text":"sprint"},{"label":"D","isCorrect":true,"text":"run"}],"hint":""},{"id":29,"content":"After the long illness, he was just a ______ of his former self.","options":[{"label":"A","isCorrect":true,"text":"shadow"},{"label":"B","isCorrect":false,"text":"ghost"},{"label":"C","isCorrect":false,"text":"shade"},{"label":"D","isCorrect":false,"text":"silhouette"}],"hint":""},{"id":30,"content":"He decided to retire while he was still in the ______ of life to travel the world.","options":[{"label":"A","isCorrect":false,"text":"peak"},{"label":"B","isCorrect":true,"text":"prime"},{"label":"C","isCorrect":false,"text":"top"},{"label":"D","isCorrect":false,"text":"height"}],"hint":""},{"id":31,"content":"Without immediate medical intervention, the victim's life will hang by a ______ .","options":[{"label":"A","isCorrect":false,"text":"string"},{"label":"B","isCorrect":false,"text":"rope"},{"label":"C","isCorrect":true,"text":"thread"},{"label":"D","isCorrect":false,"text":"hair"}],"hint":""},{"id":32,"content":"When the ambulance arrived, the victim was at death's ______ .","options":[{"label":"A","isCorrect":false,"text":"gate"},{"label":"B","isCorrect":false,"text":"porch"},{"label":"C","isCorrect":false,"text":"threshold"},{"label":"D","isCorrect":true,"text":"door"}],"hint":""},{"id":33,"content":"I can’t go to the party tonight; I’ve been as sick as a ______ all day.","options":[{"label":"A","isCorrect":true,"text":"dog"},{"label":"B","isCorrect":false,"text":"cat"},{"label":"C","isCorrect":false,"text":"parrot"},{"label":"D","isCorrect":false,"text":"pig"}],"hint":""},{"id":34,"content":"He fell down the stairs and is now black and ______ all over.","options":[{"label":"A","isCorrect":false,"text":"purple"},{"label":"B","isCorrect":true,"text":"blue"},{"label":"C","isCorrect":false,"text":"green"},{"label":"D","isCorrect":false,"text":"red"}],"hint":""},{"id":35,"content":"She was terrified to go under the ______ for her cosmetic surgery.","options":[{"label":"A","isCorrect":false,"text":"blade"},{"label":"B","isCorrect":false,"text":"scissors"},{"label":"C","isCorrect":true,"text":"knife"},{"label":"D","isCorrect":false,"text":"scalpel"}],"hint":""},{"id":36,"content":"As the old adage goes regarding health, ______ is better than cure.","options":[{"label":"A","isCorrect":false,"text":"protection"},{"label":"B","isCorrect":false,"text":"inspection"},{"label":"C","isCorrect":true,"text":"prevention"},{"label":"D","isCorrect":false,"text":"correction"}],"hint":""},{"id":37,"content":"It took him months of rehabilitation to get back on his ______ after the accident.","options":[{"label":"A","isCorrect":true,"text":"feet"},{"label":"B","isCorrect":false,"text":"legs"},{"label":"C","isCorrect":false,"text":"knees"},{"label":"D","isCorrect":false,"text":"toes"}],"hint":""},{"id":38,"content":"Excuse me, I have a ______ in my throat and can barely speak.","options":[{"label":"A","isCorrect":false,"text":"toad"},{"label":"B","isCorrect":true,"text":"frog"},{"label":"C","isCorrect":false,"text":"fish"},{"label":"D","isCorrect":false,"text":"bug"}],"hint":""},{"id":39,"content":"You look a bit green about the ______ ; perhaps you should sit down.","options":[{"label":"A","isCorrect":false,"text":"fins"},{"label":"B","isCorrect":false,"text":"lungs"},{"label":"C","isCorrect":true,"text":"gills"},{"label":"D","isCorrect":false,"text":"mouth"}],"hint":""},{"id":40,"content":"He lived a very unhealthy life and unfortunately kicked the ______ at a young age.","options":[{"label":"A","isCorrect":false,"text":"pail"},{"label":"B","isCorrect":false,"text":"can"},{"label":"C","isCorrect":false,"text":"basket"},{"label":"D","isCorrect":true,"text":"bucket"}],"hint":""},{"id":41,"content":"It is hard for her to lose weight because she has a ______ tooth and loves chocolate.","options":[{"label":"A","isCorrect":true,"text":"sweet"},{"label":"B","isCorrect":false,"text":"sharp"},{"label":"C","isCorrect":false,"text":"sugar"},{"label":"D","isCorrect":false,"text":"candy"}],"hint":""},{"id":42,"content":"He has joined a gym to try and get rid of his ______ tire.","options":[{"label":"A","isCorrect":false,"text":"extra"},{"label":"B","isCorrect":true,"text":"spare"},{"label":"C","isCorrect":false,"text":"rubber"},{"label":"D","isCorrect":false,"text":"fat"}],"hint":""},{"id":43,"content":"After a good night's sleep, I feel as fresh as a ______ .","options":[{"label":"A","isCorrect":false,"text":"rose"},{"label":"B","isCorrect":false,"text":"lily"},{"label":"C","isCorrect":true,"text":"daisy"},{"label":"D","isCorrect":false,"text":"tulip"}],"hint":""},{"id":44,"content":"When he heard the diagnosis, he turned as pale as a ______ .","options":[{"label":"A","isCorrect":false,"text":"sheet"},{"label":"B","isCorrect":false,"text":"paper"},{"label":"C","isCorrect":false,"text":"cloud"},{"label":"D","isCorrect":true,"text":"ghost"}],"hint":""},{"id":45,"content":"My grandmother always insisted that an ______ a day keeps the doctor away.","options":[{"label":"A","isCorrect":true,"text":"apple"},{"label":"B","isCorrect":false,"text":"orange"},{"label":"C","isCorrect":false,"text":"onion"},{"label":"D","isCorrect":false,"text":"egg"}],"hint":""},{"id":46,"content":"He never gets sick; he has the constitution of an ______ .","options":[{"label":"A","isCorrect":false,"text":"elephant"},{"label":"B","isCorrect":true,"text":"ox"},{"label":"C","isCorrect":false,"text":"ape"},{"label":"D","isCorrect":false,"text":"eagle"}],"hint":""},{"id":47,"content":"You need to eat more; you are nothing but ______ and bone!","options":[{"label":"A","isCorrect":false,"text":"flesh"},{"label":"B","isCorrect":false,"text":"meat"},{"label":"C","isCorrect":true,"text":"skin"},{"label":"D","isCorrect":false,"text":"blood"}],"hint":""},{"id":48,"content":"The doctor told him he had to stop smoking immediately, so he went cold ______ .","options":[{"label":"A","isCorrect":false,"text":"chicken"},{"label":"B","isCorrect":false,"text":"duck"},{"label":"C","isCorrect":false,"text":"goose"},{"label":"D","isCorrect":true,"text":"turkey"}],"hint":""},{"id":49,"content":"If you keep working 80 hours a week, you will run yourself into the ______ .","options":[{"label":"A","isCorrect":true,"text":"ground"},{"label":"B","isCorrect":false,"text":"earth"},{"label":"C","isCorrect":false,"text":"dust"},{"label":"D","isCorrect":false,"text":"floor"}],"hint":""},{"id":50,"content":"The patient’s condition took a ______ for the worse overnight.","options":[{"label":"A","isCorrect":false,"text":"spin"},{"label":"B","isCorrect":false,"text":"twist"},{"label":"C","isCorrect":true,"text":"turn"},{"label":"D","isCorrect":false,"text":"shift"}],"hint":""}];
        let quizQuestions = [];
        let currentIdx = 0;
        let userAnswers = {};
        let firstTryData = {}; 
        let initialLimit = 0;
        let finishedCount = 0;

        window.addEventListener('load', () => {
            const savedLesson = localStorage.getItem('nam_quiz_lesson');
            const savedType = localStorage.getItem('nam_quiz_type');
            const savedTheme = localStorage.getItem('nam_quiz_theme');
            if (savedLesson) document.getElementById('lessonName').value = savedLesson;
            if (savedType) document.getElementById('exerciseType').value = savedType;
            if (savedTheme) document.documentElement.style.setProperty('--bg', savedTheme);
        });

        function saveConfig() {
            localStorage.setItem('nam_quiz_lesson', document.getElementById('lessonName').value);
            localStorage.setItem('nam_quiz_type', document.getElementById('exerciseType').value);
        }

        function setTheme(color, el) {
            document.documentElement.style.setProperty('--bg', color);
            localStorage.setItem('nam_quiz_theme', color);
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
            if (el) el.classList.add('active');
        }

        function formatContent(text) {
            return text.replace(/(?:"([^"]+)"|“([^”]+)”)/g, (match, p1, p2) => {
                return '<strong>"' + (p1 || p2) + '"</strong>';
            });
        }

        function toggleSolution(id) {
            const content = document.getElementById('solution-content-' + id);
            const chevron = document.getElementById('chevron-' + id);
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                chevron.classList.remove('rotated');
            } else {
                content.classList.add('expanded');
                chevron.classList.add('rotated');
            }
        }

        function goHome() {
            location.reload();
        }

        function startQuiz() {
            saveConfig();
            const limit = parseInt(document.getElementById('limit').value) || originalPool.length;
            const shuffleQ = document.getElementById('shuffleQ').checked;
            const shuffleO = document.getElementById('shuffleO').checked;

            initialLimit = limit;
            let pool = [...originalPool];
            if (shuffleQ) pool.sort(() => Math.random() - 0.5);
            quizQuestions = pool.slice(0, limit);

            if (shuffleO) {
                quizQuestions = quizQuestions.map(q => {
                    let opts = [...q.options].sort(() => Math.random() - 0.5);
                    return {...q, options: opts.map((o, i) => ({...o, label: String.fromCharCode(65+i)}))};
                });
            }

            currentIdx = 0;
            userAnswers = {};
            firstTryData = {};
            finishedCount = 0;
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('quiz-view').classList.remove('hidden');
            document.getElementById('sub-nav').classList.remove('hidden');
            document.getElementById('display-lesson').innerText = document.getElementById('lessonName').value || 'Bài thi trắc nghiệm';
            document.getElementById('display-type').innerText = document.getElementById('exerciseType').value || 'Ôn tập';
            render();
        }

        function render() {
            const q = quizQuestions[currentIdx];
            const answer = userAnswers[currentIdx];
            
            const p = Math.round((finishedCount / initialLimit) * 100);
            document.getElementById('progress-bar').style.width = p + '%';
            document.getElementById('progress-text').innerText = p + '%';
            
            let html = `<div class="question-text">${formatContent(q.content)}</div><div class="options-grid">`;
            q.options.forEach(opt => {
                let statusClass = '';
                if (answer) {
                    if (opt.isCorrect) statusClass = 'correct';
                    else if (opt.label === answer) statusClass = 'wrong';
                }
                html += `
                <button class="option ${statusClass}" onclick="select('${opt.label}')" ${answer ? 'disabled' : ''}>
                    <div class="option-label-circle">${opt.label}</div>
                    <span style="font-weight:600; color:#475569; font-size:1.1rem;">${opt.text}</span>
                </button>`;
            });
            html += '</div>';

            if (answer && q.hint) {
                html += `
                <div class="solution-wrapper">
                    <div class="solution-header" onclick="toggleSolution('quiz')">
                        <span>HƯỚNG DẪN GIẢI</span>
                        <svg id="chevron-quiz" class="chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                    </div>
                    <div id="solution-content-quiz" class="solution-content expanded">${q.hint}</div>
                </div>`;
            }
            
            document.getElementById('question-container').innerHTML = html;
            document.getElementById('next-btn').innerText = currentIdx === quizQuestions.length - 1 ? 'KẾT QUẢ' : 'TIẾP THEO';
        }

        function select(label) {
            if (userAnswers[currentIdx]) return;
            const q = quizQuestions[currentIdx];
            const correctOpt = q.options.find(o => o.isCorrect);
            const isCorrect = (label === correctOpt.label);

            if (!(q.id in firstTryData)) {
                firstTryData[q.id] = { isCorrect, selectedLabel: label };
            }

            userAnswers[currentIdx] = label;
            render();

            if (!isCorrect) {
                const remaining = quizQuestions.slice(currentIdx + 1);
                const insertIdx = Math.floor(Math.random() * (remaining.length + 1));
                quizQuestions.splice(currentIdx + 1 + insertIdx, 0, {...q});
            } else {
                finishedCount++;
            }
        }

        function next() {
            if (!userAnswers[currentIdx]) return alert('Hãy chọn một đáp án!');
            if (currentIdx < quizQuestions.length - 1) {
                currentIdx++;
                render();
            } else {
                finish();
            }
        }

        function prev() {
            if (currentIdx > 0) {
                currentIdx--;
                render();
            }
        }

        function finish() {
            let correctFirstTime = 0;
            Object.values(firstTryData).forEach(v => { if(v.isCorrect) correctFirstTime++; });

            document.getElementById('quiz-view').classList.add('hidden');
            document.getElementById('result-view').classList.remove('hidden');
            document.getElementById('score-val').innerText = correctFirstTime;
            document.getElementById('score-total').innerText = '/ ' + initialLimit + ' câu đúng (lần đầu)';
        }

        function showReview() {
            document.getElementById('result-view').classList.add('hidden');
            document.getElementById('review-view').classList.remove('hidden');
            
            let html = '';
            const questionsInPool = originalPool.filter(q => q.id in firstTryData);
            
            questionsInPool.forEach((q, index) => {
                const data = firstTryData[q.id];
                const wasCorrect = data.isCorrect;
                const userChoice = data.selectedLabel;
                
                html += `
                <div class="review-item">
                    <div class="review-status-badge ${wasCorrect ? 'badge-pass' : 'badge-fail'}">
                        ${wasCorrect ? '✓ Đúng ngay' : '✗ Đã sai'}
                    </div>
                    <div class="question-text" style="margin-top:0; font-size:1.3rem;">
                        <span style="color:#94a3b8; font-weight:800; margin-right:10px;">#${index + 1}</span> 
                        ${formatContent(q.content)}
                    </div>
                    <div class="options-grid">`;
                
                q.options.forEach(opt => {
                    let statusClass = '';
                    let indicator = '';
                    if (opt.isCorrect) {
                        statusClass = 'correct';
                        indicator = ' <span style="margin-left:auto; font-weight:800; font-size:1.2rem;">✓</span>';
                    } else if (opt.label === userChoice && !wasCorrect) {
                        statusClass = 'wrong';
                        indicator = ' <span style="margin-left:auto; font-weight:800; font-size:1.2rem;">✗</span>';
                    }
                    html += `
                    <div class="option ${statusClass}" style="cursor:default;">
                        <div class="option-label-circle">${opt.label}</div>
                        <span style="font-weight:600; color:#475569;">${opt.text}</span>
                        ${indicator}
                    </div>`;
                });
                
                html += '</div>';
                if (q.hint) {
                    html += `
                    <div class="solution-wrapper">
                        <div class="solution-header" onclick="toggleSolution('${index}')">
                            <span>HƯỚNG DẪN GIẢI</span>
                            <svg id="chevron-${index}" class="chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                        </div>
                        <div id="solution-content-${index}" class="solution-content">${q.hint}</div>
                    </div>`;
                }
                html += '</div>';
            });
            document.getElementById('review-container').innerHTML = html;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function hideReview() {
            document.getElementById('review-view').classList.add('hidden');
            document.getElementById('result-view').classList.remove('hidden');
        }
    </script>
</body>
</html>
