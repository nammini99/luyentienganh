<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Học tập: TEST---11</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #4f46e5; 
            --primary-light: #eef2ff;
            --bg: #f8fafc; 
            --text: #1e293b; 
            --correct: #10b981; 
            --correct-bg: #f0fdf4;
            --wrong: #ef4444; 
            --wrong-bg: #fef2f2;
            --border: #e2e8f0;
            --solution-bg: #f5f3ff;
            --solution-text: #4338ca;
        }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: var(--text); line-height: 1.6; margin: 0; padding: 0; transition: background-color 0.3s; }
        
        .branding-header { background: #000; color: #fbbf24; padding: 12px 20px; text-align: center; font-weight: 800; font-size: 0.95rem; letter-spacing: 0.05em; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 1000; }
        .app-sub-header { background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); padding: 10px 20px; display: flex; justify-content: flex-end; position: sticky; top: 45px; z-index: 900; }
        
        .container { max-width: 900px; margin: 40px auto; padding: 0 20px; }
        .card { background: white; border-radius: 32px; padding: 40px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05); margin-bottom: 24px; border: 1px solid var(--border); }
        
        .setup-header { text-align: center; margin-bottom: 40px; }
        .setup-header h1 { font-weight: 800; color: #0f172a; font-size: 2rem; margin-bottom: 8px; }
        
        .input-group { margin-bottom: 20px; text-align: left; }
        .input-group label { display: block; font-weight: 800; font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px; }
        .input-control { width: 100%; padding: 14px 20px; border-radius: 16px; border: 2px solid var(--border); font-family: inherit; font-size: 1rem; font-weight: 600; box-sizing: border-box; }
        
        .theme-picker { display: flex; gap: 10px; align-items: center; margin-top: 5px; }
        .color-dot { width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; cursor: pointer; box-shadow: 0 0 0 2px var(--border); transition: transform 0.2s; }
        .color-dot.active { box-shadow: 0 0 0 2px var(--primary); }
        
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 30px; background: #f1f5f9; padding: 25px; border-radius: 24px; }
        
        .btn { padding: 16px 32px; border-radius: 18px; font-weight: 800; border: none; cursor: pointer; transition: all 0.2s; font-family: inherit; font-size: 1rem; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-ghost { background: #e2e8f0; color: #475569; }
        
        .progress-bar-wrap { width: 100%; height: 12px; background: #e2e8f0; border-radius: 100px; overflow: hidden; margin: 20px 0; }
        .progress-bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        
        .question-text { font-size: 1.5rem; font-weight: 700; margin: 30px 0; color: #0f172a; }
        .question-text strong { color: var(--primary); border-bottom: 3px solid var(--primary-light); }
        
        .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 16px; }
        .option { padding: 20px 24px; border: 2px solid var(--border); border-radius: 20px; display: flex; align-items: center; gap: 18px; cursor: pointer; transition: all 0.2s; background: white; text-align: left; width: 100%; box-sizing: border-box; }
        .option.correct { border-color: var(--correct); background: var(--correct-bg); }
        .option.wrong { border-color: var(--wrong); background: var(--wrong-bg); }
        .option-label-circle { width:36px; height:36px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:800; color: #64748b; background: #f1f5f9; flex-shrink:0; }
        .option.correct .option-label-circle { background: var(--correct); color: white; }
        .option.wrong .option-label-circle { background: var(--wrong); color: white; }

        /* Hướng dẫn giải (Collapse) */
        .solution-wrapper { margin-top: 24px; border-radius: 20px; overflow: hidden; border: 1px solid var(--border); background: white; }
        .solution-header { padding: 16px 24px; background: var(--solution-bg); color: var(--solution-text); font-weight: 800; font-size: 0.9rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none; transition: background 0.2s; }
        .solution-header:hover { background: #ede9fe; }
        .solution-content { padding: 0; max-height: 0; overflow: hidden; transition: all 0.3s ease-out; opacity: 0; }
        .solution-content.expanded { padding: 24px; max-height: 1000px; opacity: 1; border-top: 1px solid var(--border); }
        .chevron { transition: transform 0.3s; }
        .chevron.rotated { transform: rotate(180deg); }

        .hidden { display: none; }
        .result-score { font-size: 6rem; font-weight: 900; color: var(--primary); line-height: 1; margin: 20px 0; }
        
        /* Review Styles */
        .review-item { background: white; border: 1px solid var(--border); border-radius: 24px; padding: 30px; margin-bottom: 24px; }
        .review-status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 12px; font-size: 0.8rem; font-weight: 800; text-transform: uppercase; margin-bottom: 20px; }
        .badge-pass { background: var(--correct-bg); color: var(--correct); }
        .badge-fail { background: var(--wrong-bg); color: var(--wrong); }
    </style>
</head>
<body>
    <div class="branding-header">Trợ Lý Nam Mini (0968584585 --- Fb: Nam Mini)</div>
    
    <div id="sub-nav" class="app-sub-header hidden">
        <button class="btn btn-ghost" style="padding: 8px 16px; font-size: 0.8rem; border-radius: 10px;" onclick="goHome()">QUAY LẠI CỬA SỔ CHÍNH</button>
    </div>

    <div class="container">
        <!-- SETUP VIEW -->
        <div id="setup-view" class="card">
            <div class="setup-header">
                <h1>Hệ thống Trắc nghiệm</h1>
                <p style="color: #64748b;">Nhập liệu một lần - Học tập mãi mãi</p>
            </div>

            <div class="input-group">
                <label>Tên bài học</label>
                <input type="text" id="lessonName" class="input-control" placeholder="Ví dụ: Unit 1: Vocabulary" oninput="saveConfig()">
            </div>

            <div class="input-group">
                <label>Dạng bài tập</label>
                <input type="text" id="exerciseType" class="input-control" placeholder="Ví dụ: Multiple Choice" oninput="saveConfig()">
            </div>

            <div class="input-group">
                <label>Màu nền (Theme Solid)</label>
                <div class="theme-picker">
                    <div class="color-dot active" style="background: #f8fafc;" onclick="setTheme('#f8fafc', this)"></div>
                    <div class="color-dot" style="background: #f0fdf4;" onclick="setTheme('#f0fdf4', this)"></div>
                    <div class="color-dot" style="background: #fdf2f8;" onclick="setTheme('#fdf2f8', this)"></div>
                    <div class="color-dot" style="background: #eef2ff;" onclick="setTheme('#eef2ff', this)"></div>
                    <div class="color-dot" style="background: #fffbeb;" onclick="setTheme('#fffbeb', this)"></div>
                    <input type="color" id="customColor" style="width: 32px; height: 32px; padding: 0; border: none; cursor: pointer; border-radius: 50%;" oninput="setTheme(this.value, null)">
                </div>
            </div>

            <div class="settings-grid">
                <div class="input-group" style="margin-bottom: 0;">
                    <label>Số câu hỏi</label>
                    <input type="number" id="limit" class="input-control" value="50" min="1" max="50" style="width: 100px;">
                </div>
                <div style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center;">
                    <label style="font-weight: 800; font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px;">Tùy chọn</label>
                    <div style="display: flex; gap: 20px; font-weight: 700; font-size: 0.9rem;">
                        <label style="cursor: pointer;"><input type="checkbox" id="shuffleQ" checked> Đảo câu</label>
                        <label style="cursor: pointer;"><input type="checkbox" id="shuffleO" checked> Đảo đáp án</label>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" style="margin-top: 40px;" onclick="startQuiz()">BẮT ĐẦU LUYỆN TẬP</button>
        </div>

        <!-- QUIZ VIEW -->
        <div id="quiz-view" class="hidden">
            <div style="margin-bottom: 30px;">
                <h2 id="display-lesson" style="font-size: 1.5rem; font-weight: 800; color: #0f172a; margin: 0;"></h2>
                <p id="display-type" style="font-size: 1rem; font-weight: 700; color: #64748b; margin: 4px 0 20px;"></p>
                <div class="progress-bar-wrap">
                    <div id="progress-bar" class="progress-bar-fill"></div>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 800; color: #94a3b8;">
                    <span>TIẾN ĐỘ HOÀN THÀNH</span>
                    <span id="progress-text">0%</span>
                </div>
            </div>

            <div class="card" id="quiz-card-container">
                <div id="question-container"></div>
                <div style="margin-top: 40px; display: flex; gap: 15px;">
                    <button class="btn btn-ghost" style="flex: 1;" onclick="prev()">QUAY LẠI</button>
                    <button id="next-btn" class="btn btn-primary" style="flex: 2;" onclick="next()">TIẾP THEO</button>
                </div>
            </div>
        </div>

        <!-- RESULT VIEW -->
        <div id="result-view" class="card hidden" style="text-align: center;">
            <div class="result-score" id="score-val">0</div>
            <p id="score-total" style="font-size: 1.5rem; color: #94a3b8; font-weight: 800; margin-bottom: 30px;"></p>
            <h2 style="font-weight: 800; font-size: 2rem; margin-bottom: 12px;">Bài thi hoàn tất!</h2>
            <div style="display: flex; flex-direction: column; gap: 15px; align-items: center; margin-top: 40px;">
                <button class="btn btn-primary" style="width: 320px;" onclick="showReview()">XEM LẠI ĐÁP ÁN CHI TIẾT</button>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-ghost" onclick="location.reload()">LÀM LẠI</button>
                    <button class="btn btn-ghost" onclick="goHome()">TRANG CHỦ</button>
                </div>
            </div>
        </div>

        <!-- REVIEW VIEW -->
        <div id="review-view" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="font-weight: 800; font-size: 1.8rem; margin: 0; color: #0f172a;">Báo cáo chi tiết</h2>
                <button class="btn btn-ghost" style="padding: 10px 24px; border-radius: 14px;" onclick="hideReview()">ĐÓNG</button>
            </div>
            <div id="review-container"></div>
        </div>
    </div>

    <script>
        const originalPool = [{"id":1,"content":"Due to his reckless behavior, he is likely to ______ a serious infectious disease.","options":[{"label":"A","isCorrect":false,"text":"obtain"},{"label":"B","isCorrect":false,"text":"gain"},{"label":"C","isCorrect":true,"text":"contract"},{"label":"D","isCorrect":false,"text":"secure"}],"hint":""},{"id":2,"content":"The doctor prescribed a strong painkiller to ______ the patient’s suffering after the surgery.","options":[{"label":"A","isCorrect":false,"text":"defuse"},{"label":"B","isCorrect":true,"text":"alleviate"},{"label":"C","isCorrect":false,"text":"downgrade"},{"label":"D","isCorrect":false,"text":"evaporate"}],"hint":""},{"id":3,"content":"To improve longevity, experts suggest that individuals ______ a rigorous exercise regimen early in life.","options":[{"label":"A","isCorrect":true,"text":"adopt"},{"label":"B","isCorrect":false,"text":"adapt"},{"label":"C","isCorrect":false,"text":"adept"},{"label":"D","isCorrect":false,"text":"align"}],"hint":""},{"id":4,"content":"The surgeon had to ______ a complex operation to remove the tumor from the patient's brain.","options":[{"label":"A","isCorrect":false,"text":"act"},{"label":"B","isCorrect":false,"text":"transact"},{"label":"C","isCorrect":false,"text":"produce"},{"label":"D","isCorrect":true,"text":"perform"}],"hint":""},{"id":5,"content":"Consuming foods rich in antioxidants can help ______ the immune system against potential viruses.","options":[{"label":"A","isCorrect":false,"text":"inflate"},{"label":"B","isCorrect":false,"text":"magnify"},{"label":"C","isCorrect":true,"text":"bolster"},{"label":"D","isCorrect":false,"text":"expand"}],"hint":""},{"id":6,"content":"Obesity continues to ______ a significant threat to public health systems worldwide.","options":[{"label":"A","isCorrect":false,"text":"place"},{"label":"B","isCorrect":true,"text":"pose"},{"label":"C","isCorrect":false,"text":"set"},{"label":"D","isCorrect":false,"text":"lay"}],"hint":""},{"id":7,"content":"Drinking a glass of water before meals can help ______ your appetite, preventing overeating.","options":[{"label":"A","isCorrect":true,"text":"curb"},{"label":"B","isCorrect":false,"text":"snub"},{"label":"C","isCorrect":false,"text":"bridles"},{"label":"D","isCorrect":false,"text":"fence"}],"hint":""},{"id":8,"content":"In emergency situations, paramedics are authorized to ______ life-saving medication immediately.","options":[{"label":"A","isCorrect":false,"text":"allocate"},{"label":"B","isCorrect":false,"text":"dispense"},{"label":"C","isCorrect":true,"text":"administer"},{"label":"D","isCorrect":false,"text":"execute"}],"hint":""},{"id":9,"content":"While playing professional football, he ______ a career-ending injury to his knee.","options":[{"label":"A","isCorrect":false,"text":"retained"},{"label":"B","isCorrect":false,"text":"maintained"},{"label":"C","isCorrect":true,"text":"sustained"},{"label":"D","isCorrect":false,"text":"detained"}],"hint":""},{"id":10,"content":"The therapist recommended herbal tea to ______ sleep for those suffering from mild insomnia.","options":[{"label":"A","isCorrect":false,"text":"provoke"},{"label":"B","isCorrect":true,"text":"induce"},{"label":"C","isCorrect":false,"text":"incite"},{"label":"D","isCorrect":false,"text":"deduce"}],"hint":""},{"id":11,"content":"It takes immense willpower to ______ the habit of smoking after years of addiction.","options":[{"label":"A","isCorrect":true,"text":"kick"},{"label":"B","isCorrect":false,"text":"punch"},{"label":"C","isCorrect":false,"text":"strike"},{"label":"D","isCorrect":false,"text":"hit"}],"hint":""},{"id":12,"content":"Modern medicine strives not only to cure illness but to ______ life expectancy through preventive care.","options":[{"label":"A","isCorrect":false,"text":"protract"},{"label":"B","isCorrect":false,"text":"elongate"},{"label":"C","isCorrect":false,"text":"stretch"},{"label":"D","isCorrect":true,"text":"prolong"}],"hint":""},{"id":13,"content":"Advanced screening allows doctors to ______ terminal illnesses at their earliest stages.","options":[{"label":"A","isCorrect":false,"text":"distinguish"},{"label":"B","isCorrect":false,"text":"discern"},{"label":"C","isCorrect":true,"text":"diagnose"},{"label":"D","isCorrect":false,"text":"define"}],"hint":""},{"id":14,"content":"Patients must ______ strictly to the treatment plan to ensure a full recovery.","options":[{"label":"A","isCorrect":false,"text":"cohere"},{"label":"B","isCorrect":true,"text":"adhere"},{"label":"C","isCorrect":false,"text":"cling"},{"label":"D","isCorrect":false,"text":"bind"}],"hint":""},{"id":15,"content":"The marathon runner had to ______ every ounce of energy to cross the finish line.","options":[{"label":"A","isCorrect":true,"text":"expend"},{"label":"B","isCorrect":false,"text":"exhaust"},{"label":"C","isCorrect":false,"text":"consume"},{"label":"D","isCorrect":false,"text":"deplete"}],"hint":""},{"id":16,"content":"The patient began to ______ symptoms of the virus three days after exposure.","options":[{"label":"A","isCorrect":false,"text":"illustrate"},{"label":"B","isCorrect":false,"text":"demonstrate"},{"label":"C","isCorrect":false,"text":"expose"},{"label":"D","isCorrect":true,"text":"manifest"}],"hint":""},{"id":17,"content":"Regular cardiovascular activity helps ______ stamina and cardiovascular endurance.","options":[{"label":"A","isCorrect":false,"text":"fabricate"},{"label":"B","isCorrect":false,"text":"construct"},{"label":"C","isCorrect":true,"text":"build"},{"label":"D","isCorrect":false,"text":"assemble"}],"hint":""},{"id":18,"content":"If you experience persistent chest pain, you should ______ medical attention immediately.","options":[{"label":"A","isCorrect":false,"text":"search"},{"label":"B","isCorrect":true,"text":"seek"},{"label":"C","isCorrect":false,"text":"hunt"},{"label":"D","isCorrect":false,"text":"pursue"}],"hint":""},{"id":19,"content":"Doctors often ______ antibiotics for bacterial infections, though resistance is a growing concern.","options":[{"label":"A","isCorrect":true,"text":"prescribe"},{"label":"B","isCorrect":false,"text":"proscribe"},{"label":"C","isCorrect":false,"text":"ascribe"},{"label":"D","isCorrect":false,"text":"subscribe"}],"hint":""},{"id":20,"content":"Many office workers ______ a sedentary lifestyle, which contributes to various health issues.","options":[{"label":"A","isCorrect":false,"text":"guide"},{"label":"B","isCorrect":false,"text":"drive"},{"label":"C","isCorrect":false,"text":"steer"},{"label":"D","isCorrect":true,"text":"lead"}],"hint":""},{"id":21,"content":"After the accident, the patient was monitored ______ in the Intensive Care Unit.","options":[{"label":"A","isCorrect":true,"text":"closely"},{"label":"B","isCorrect":false,"text":"nearly"},{"label":"C","isCorrect":false,"text":"proximately"},{"label":"D","isCorrect":false,"text":"tightly"}],"hint":""},{"id":22,"content":"Nutritional requirements can ______ widely depending on a person's age and activity level.","options":[{"label":"A","isCorrect":false,"text":"alter"},{"label":"B","isCorrect":true,"text":"vary"},{"label":"C","isCorrect":false,"text":"shift"},{"label":"D","isCorrect":false,"text":"move"}],"hint":""},{"id":23,"content":"Without proper medical intervention, his condition began to ______ rapidly.","options":[{"label":"A","isCorrect":false,"text":"degenerate"},{"label":"B","isCorrect":false,"text":"decompose"},{"label":"C","isCorrect":true,"text":"deteriorate"},{"label":"D","isCorrect":false,"text":"descend"}],"hint":""},{"id":24,"content":"The child refused ______ to eat his vegetables, despite his parents' insistence.","options":[{"label":"A","isCorrect":false,"text":"firmly"},{"label":"B","isCorrect":false,"text":"solidly"},{"label":"C","isCorrect":false,"text":"rigidly"},{"label":"D","isCorrect":true,"text":"flatly"}],"hint":""},{"id":25,"content":"The new strain of the virus spreads ______ within crowded indoor environments.","options":[{"label":"A","isCorrect":true,"text":"rapidly"},{"label":"B","isCorrect":false,"text":"hastily"},{"label":"C","isCorrect":false,"text":"speedily"},{"label":"D","isCorrect":false,"text":"hurriedly"}],"hint":""},{"id":26,"content":"To see real fitness results, one must exercise ______ at least three times a week.","options":[{"label":"A","isCorrect":false,"text":"potently"},{"label":"B","isCorrect":true,"text":"vigorously"},{"label":"C","isCorrect":false,"text":"forcefully"},{"label":"D","isCorrect":false,"text":"powerfully"}],"hint":""},{"id":27,"content":"The World Health Organization recommends ______ that sugar intake be reduced.","options":[{"label":"A","isCorrect":false,"text":"heavy"},{"label":"B","isCorrect":false,"text":"hard"},{"label":"C","isCorrect":true,"text":"strongly"},{"label":"D","isCorrect":false,"text":"toughly"}],"hint":""},{"id":28,"content":"Against all odds, the comatose patient recovered ______ after the experimental treatment.","options":[{"label":"A","isCorrect":false,"text":"marvelously"},{"label":"B","isCorrect":false,"text":"spectacularly"},{"label":"C","isCorrect":false,"text":"wonderfully"},{"label":"D","isCorrect":true,"text":"miraculously"}],"hint":""},{"id":29,"content":"Smoking is prohibited ______ in all hospital buildings to protect patient health.","options":[{"label":"A","isCorrect":true,"text":"strictly"},{"label":"B","isCorrect":false,"text":"severely"},{"label":"C","isCorrect":false,"text":"sternly"},{"label":"D","isCorrect":false,"text":"harshly"}],"hint":""},{"id":30,"content":"He has suffered ______ from back pain for over a decade.","options":[{"label":"A","isCorrect":false,"text":"perpetually"},{"label":"B","isCorrect":true,"text":"chronically"},{"label":"C","isCorrect":false,"text":"enduringly"},{"label":"D","isCorrect":false,"text":"lastingly"}],"hint":""},{"id":31,"content":"Poor air quality impacts ______ on the respiratory health of young children.","options":[{"label":"A","isCorrect":false,"text":"diversely"},{"label":"B","isCorrect":false,"text":"conversely"},{"label":"C","isCorrect":true,"text":"adversely"},{"label":"D","isCorrect":false,"text":"reversely"}],"hint":""},{"id":32,"content":"Elderly patients often depend ______ on caregivers for their daily needs.","options":[{"label":"A","isCorrect":false,"text":"weightily"},{"label":"B","isCorrect":false,"text":"massively"},{"label":"C","isCorrect":false,"text":"densely"},{"label":"D","isCorrect":true,"text":"heavily"}],"hint":""},{"id":33,"content":"A balanced diet contributes ______ to the maintenance of a healthy weight.","options":[{"label":"A","isCorrect":true,"text":"significantly"},{"label":"B","isCorrect":false,"text":"expressively"},{"label":"C","isCorrect":false,"text":"meaningfully"},{"label":"D","isCorrect":false,"text":"indicatively"}],"hint":""},{"id":34,"content":"Fortunately, the patient responded ______ to the first round of chemotherapy.","options":[{"label":"A","isCorrect":false,"text":"kindly"},{"label":"B","isCorrect":true,"text":"favorably"},{"label":"C","isCorrect":false,"text":"affectionately"},{"label":"D","isCorrect":false,"text":"friendly"}],"hint":""},{"id":35,"content":"Childhood obesity rates have risen ______ in the last twenty years.","options":[{"label":"A","isCorrect":false,"text":"theatrically"},{"label":"B","isCorrect":false,"text":"staged"},{"label":"C","isCorrect":true,"text":"dramatically"},{"label":"D","isCorrect":false,"text":"play"}],"hint":""},{"id":36,"content":"The hospice care center is designed for patients who are ______ ill.","options":[{"label":"A","isCorrect":false,"text":"final"},{"label":"B","isCorrect":false,"text":"deadly"},{"label":"C","isCorrect":false,"text":"ending"},{"label":"D","isCorrect":true,"text":"terminally"}],"hint":""},{"id":37,"content":"Measles is a ______ infectious disease that requires high vaccination coverage.","options":[{"label":"A","isCorrect":true,"text":"highly"},{"label":"B","isCorrect":false,"text":"deeply"},{"label":"C","isCorrect":false,"text":"tall"},{"label":"D","isCorrect":false,"text":"greatly"}],"hint":""},{"id":38,"content":"Modern laparoscopic surgery is ______ invasive, resulting in faster recovery times.","options":[{"label":"A","isCorrect":false,"text":"shortly"},{"label":"B","isCorrect":true,"text":"minimally"},{"label":"C","isCorrect":false,"text":"small"},{"label":"D","isCorrect":false,"text":"tiny"}],"hint":""},{"id":39,"content":"To join the special forces, candidates must be ______ fit and mentally resilient.","options":[{"label":"A","isCorrect":false,"text":"bodily"},{"label":"B","isCorrect":false,"text":"carnally"},{"label":"C","isCorrect":true,"text":"physically"},{"label":"D","isCorrect":false,"text":"organically"}],"hint":""},{"id":40,"content":"A diet that is ______ deficient can lead to stunted growth in children.","options":[{"label":"A","isCorrect":false,"text":"alimentary"},{"label":"B","isCorrect":false,"text":"dietary"},{"label":"C","isCorrect":true,"text":"nutritionally"},{"label":"D","isCorrect":false,"text":"food"}],"hint":""},{"id":41,"content":"There is still debate over the long-term safety of ______ modified foods.","options":[{"label":"A","isCorrect":true,"text":"genetically"},{"label":"B","isCorrect":false,"text":"hereditary"},{"label":"C","isCorrect":false,"text":"ancestry"},{"label":"D","isCorrect":false,"text":"gene"}],"hint":""},{"id":42,"content":"This new drug has been ______ proven to lower cholesterol levels effectively.","options":[{"label":"A","isCorrect":false,"text":"medically"},{"label":"B","isCorrect":true,"text":"clinically"},{"label":"C","isCorrect":false,"text":"surgically"},{"label":"D","isCorrect":false,"text":"operatively"}],"hint":""},{"id":43,"content":"Despite his age, he remains ______ alert and solves crosswords daily.","options":[{"label":"A","isCorrect":false,"text":"brainy"},{"label":"B","isCorrect":false,"text":"psychically"},{"label":"C","isCorrect":true,"text":"mentally"},{"label":"D","isCorrect":false,"text":"thought"}],"hint":""},{"id":44,"content":"It is ______ impossible to completely sterilize an environment outside a laboratory.","options":[{"label":"A","isCorrect":false,"text":"really"},{"label":"B","isCorrect":false,"text":"truly"},{"label":"C","isCorrect":false,"text":"very"},{"label":"D","isCorrect":true,"text":"virtually"}],"hint":""},{"id":45,"content":"Snake bites in this region are ______ fatal if antivenom is not administered quickly.","options":[{"label":"A","isCorrect":true,"text":"potentially"},{"label":"B","isCorrect":false,"text":"ability"},{"label":"C","isCorrect":false,"text":"capably"},{"label":"D","isCorrect":false,"text":"possibly"}],"hint":""},{"id":46,"content":"Fresh fruits and vegetables should be ______ available to all school children.","options":[{"label":"A","isCorrect":false,"text":"handily"},{"label":"B","isCorrect":true,"text":"readily"},{"label":"C","isCorrect":false,"text":"willingly"},{"label":"D","isCorrect":false,"text":"eagerly"}],"hint":""},{"id":47,"content":"Patient records are kept ______ confidential to protect privacy.","options":[{"label":"A","isCorrect":false,"text":"hardly"},{"label":"B","isCorrect":false,"text":"tightly"},{"label":"C","isCorrect":true,"text":"strictly"},{"label":"D","isCorrect":false,"text":"tautly"}],"hint":""},{"id":48,"content":"The hiker was found ______ dehydrated after being lost in the desert for three days.","options":[{"label":"A","isCorrect":false,"text":"crucially"},{"label":"B","isCorrect":false,"text":"acutely"},{"label":"C","isCorrect":false,"text":"gravely"},{"label":"D","isCorrect":true,"text":"severely"}],"hint":""},{"id":49,"content":"The new health guidelines are ______ sound and based on years of research.","options":[{"label":"A","isCorrect":true,"text":"scientifically"},{"label":"B","isCorrect":false,"text":"knowledgeably"},{"label":"C","isCorrect":false,"text":"academic"},{"label":"D","isCorrect":false,"text":"scholarly"}],"hint":""},{"id":50,"content":"The doctor was concerned because the patient was ______ obese, increasing heart attack risk.","options":[{"label":"A","isCorrect":false,"text":"sadly"},{"label":"B","isCorrect":true,"text":"morbidly"},{"label":"C","isCorrect":false,"text":"deadly"},{"label":"D","isCorrect":false,"text":"gloomily"}],"hint":""}];
        let quizQuestions = [];
        let currentIdx = 0;
        let userAnswers = {};
        let firstTryData = {}; 
        let initialLimit = 0;
        let finishedCount = 0;

        window.addEventListener('load', () => {
            const savedLesson = localStorage.getItem('nam_quiz_lesson');
            const savedType = localStorage.getItem('nam_quiz_type');
            const savedTheme = localStorage.getItem('nam_quiz_theme');
            if (savedLesson) document.getElementById('lessonName').value = savedLesson;
            if (savedType) document.getElementById('exerciseType').value = savedType;
            if (savedTheme) document.documentElement.style.setProperty('--bg', savedTheme);
        });

        function saveConfig() {
            localStorage.setItem('nam_quiz_lesson', document.getElementById('lessonName').value);
            localStorage.setItem('nam_quiz_type', document.getElementById('exerciseType').value);
        }

        function setTheme(color, el) {
            document.documentElement.style.setProperty('--bg', color);
            localStorage.setItem('nam_quiz_theme', color);
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
            if (el) el.classList.add('active');
        }

        function formatContent(text) {
            return text.replace(/(?:"([^"]+)"|“([^”]+)”)/g, (match, p1, p2) => {
                return '<strong>"' + (p1 || p2) + '"</strong>';
            });
        }

        function toggleSolution(id) {
            const content = document.getElementById('solution-content-' + id);
            const chevron = document.getElementById('chevron-' + id);
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                chevron.classList.remove('rotated');
            } else {
                content.classList.add('expanded');
                chevron.classList.add('rotated');
            }
        }

        function goHome() {
            location.reload();
        }

        function startQuiz() {
            saveConfig();
            const limit = parseInt(document.getElementById('limit').value) || originalPool.length;
            const shuffleQ = document.getElementById('shuffleQ').checked;
            const shuffleO = document.getElementById('shuffleO').checked;

            initialLimit = limit;
            let pool = [...originalPool];
            if (shuffleQ) pool.sort(() => Math.random() - 0.5);
            quizQuestions = pool.slice(0, limit);

            if (shuffleO) {
                quizQuestions = quizQuestions.map(q => {
                    let opts = [...q.options].sort(() => Math.random() - 0.5);
                    return {...q, options: opts.map((o, i) => ({...o, label: String.fromCharCode(65+i)}))};
                });
            }

            currentIdx = 0;
            userAnswers = {};
            firstTryData = {};
            finishedCount = 0;
            document.getElementById('setup-view').classList.add('hidden');
            document.getElementById('quiz-view').classList.remove('hidden');
            document.getElementById('sub-nav').classList.remove('hidden');
            document.getElementById('display-lesson').innerText = document.getElementById('lessonName').value || 'Bài thi trắc nghiệm';
            document.getElementById('display-type').innerText = document.getElementById('exerciseType').value || 'Ôn tập';
            render();
        }

        function render() {
            const q = quizQuestions[currentIdx];
            const answer = userAnswers[currentIdx];
            
            const p = Math.round((finishedCount / initialLimit) * 100);
            document.getElementById('progress-bar').style.width = p + '%';
            document.getElementById('progress-text').innerText = p + '%';
            
            let html = `<div class="question-text">${formatContent(q.content)}</div><div class="options-grid">`;
            q.options.forEach(opt => {
                let statusClass = '';
                if (answer) {
                    if (opt.isCorrect) statusClass = 'correct';
                    else if (opt.label === answer) statusClass = 'wrong';
                }
                html += `
                <button class="option ${statusClass}" onclick="select('${opt.label}')" ${answer ? 'disabled' : ''}>
                    <div class="option-label-circle">${opt.label}</div>
                    <span style="font-weight:600; color:#475569; font-size:1.1rem;">${opt.text}</span>
                </button>`;
            });
            html += '</div>';

            if (answer && q.hint) {
                html += `
                <div class="solution-wrapper">
                    <div class="solution-header" onclick="toggleSolution('quiz')">
                        <span>HƯỚNG DẪN GIẢI</span>
                        <svg id="chevron-quiz" class="chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                    </div>
                    <div id="solution-content-quiz" class="solution-content expanded">${q.hint}</div>
                </div>`;
            }
            
            document.getElementById('question-container').innerHTML = html;
            document.getElementById('next-btn').innerText = currentIdx === quizQuestions.length - 1 ? 'KẾT QUẢ' : 'TIẾP THEO';
        }

        function select(label) {
            if (userAnswers[currentIdx]) return;
            const q = quizQuestions[currentIdx];
            const correctOpt = q.options.find(o => o.isCorrect);
            const isCorrect = (label === correctOpt.label);

            if (!(q.id in firstTryData)) {
                firstTryData[q.id] = { isCorrect, selectedLabel: label };
            }

            userAnswers[currentIdx] = label;
            render();

            if (!isCorrect) {
                const remaining = quizQuestions.slice(currentIdx + 1);
                const insertIdx = Math.floor(Math.random() * (remaining.length + 1));
                quizQuestions.splice(currentIdx + 1 + insertIdx, 0, {...q});
            } else {
                finishedCount++;
            }
        }

        function next() {
            if (!userAnswers[currentIdx]) return alert('Hãy chọn một đáp án!');
            if (currentIdx < quizQuestions.length - 1) {
                currentIdx++;
                render();
            } else {
                finish();
            }
        }

        function prev() {
            if (currentIdx > 0) {
                currentIdx--;
                render();
            }
        }

        function finish() {
            let correctFirstTime = 0;
            Object.values(firstTryData).forEach(v => { if(v.isCorrect) correctFirstTime++; });

            document.getElementById('quiz-view').classList.add('hidden');
            document.getElementById('result-view').classList.remove('hidden');
            document.getElementById('score-val').innerText = correctFirstTime;
            document.getElementById('score-total').innerText = '/ ' + initialLimit + ' câu đúng (lần đầu)';
        }

        function showReview() {
            document.getElementById('result-view').classList.add('hidden');
            document.getElementById('review-view').classList.remove('hidden');
            
            let html = '';
            const questionsInPool = originalPool.filter(q => q.id in firstTryData);
            
            questionsInPool.forEach((q, index) => {
                const data = firstTryData[q.id];
                const wasCorrect = data.isCorrect;
                const userChoice = data.selectedLabel;
                
                html += `
                <div class="review-item">
                    <div class="review-status-badge ${wasCorrect ? 'badge-pass' : 'badge-fail'}">
                        ${wasCorrect ? '✓ Đúng ngay' : '✗ Đã sai'}
                    </div>
                    <div class="question-text" style="margin-top:0; font-size:1.3rem;">
                        <span style="color:#94a3b8; font-weight:800; margin-right:10px;">#${index + 1}</span> 
                        ${formatContent(q.content)}
                    </div>
                    <div class="options-grid">`;
                
                q.options.forEach(opt => {
                    let statusClass = '';
                    let indicator = '';
                    if (opt.isCorrect) {
                        statusClass = 'correct';
                        indicator = ' <span style="margin-left:auto; font-weight:800; font-size:1.2rem;">✓</span>';
                    } else if (opt.label === userChoice && !wasCorrect) {
                        statusClass = 'wrong';
                        indicator = ' <span style="margin-left:auto; font-weight:800; font-size:1.2rem;">✗</span>';
                    }
                    html += `
                    <div class="option ${statusClass}" style="cursor:default;">
                        <div class="option-label-circle">${opt.label}</div>
                        <span style="font-weight:600; color:#475569;">${opt.text}</span>
                        ${indicator}
                    </div>`;
                });
                
                html += '</div>';
                if (q.hint) {
                    html += `
                    <div class="solution-wrapper">
                        <div class="solution-header" onclick="toggleSolution('${index}')">
                            <span>HƯỚNG DẪN GIẢI</span>
                            <svg id="chevron-${index}" class="chevron" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>
                        </div>
                        <div id="solution-content-${index}" class="solution-content">${q.hint}</div>
                    </div>`;
                }
                html += '</div>';
            });
            document.getElementById('review-container').innerHTML = html;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function hideReview() {
            document.getElementById('review-view').classList.add('hidden');
            document.getElementById('result-view').classList.remove('hidden');
        }
    </script>
</body>
</html>